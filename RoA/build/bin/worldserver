#!/bin/bash
set -e

WORLDSERVER="/azerothcore/build/bin/worldserver"
SOURCE_CONFIG="/azerothcore-build/config/worldserver.conf"
DEST_CONFIG="/azerothcore/build/etc/worldserver.conf"
COMPILE_LOCK="/azerothcore-build/tmp/.compiled"

copy_config() {
    echo "Copying worldserver configuration..."
    cp "$SOURCE_CONFIG" "$DEST_CONFIG"
    echo "Configuration copied."
}

start_worldserver() {
    echo "Starting worldserver in the background..."
    $WORLDSERVER &
    WORLDSERVER_PID=$!
    echo "Worldserver started with PID: $WORLDSERVER_PID"
}

stop_worldserver() {
    if [ ! -z "$WORLDSERVER_PID" ]; then
        echo "Stopping worldserver (PID: $WORLDSERVER_PID)..."
        kill $WORLDSERVER_PID 2>/dev/null || true
        wait $WORLDSERVER_PID 2>/dev/null || true
        echo "Worldserver stopped."
    fi
}

# Copy config and start worldserver initially
copy_config
start_worldserver

echo "Monitoring COMPILE_LOCK file..."
last_modified=$(stat -c %Y "$COMPILE_LOCK" 2>/dev/null || echo 0)

while true; do
    if [ -f "$COMPILE_LOCK" ]; then
        current_modified=$(stat -c %Y "$COMPILE_LOCK")
        if [ "$current_modified" != "$last_modified" ]; then
            echo "COMPILE_LOCK file has been touched or created."
            stop_worldserver
            copy_config
            start_worldserver
            last_modified=$current_modified
        fi
    else
        if [ "$last_modified" != "0" ]; then
            echo "COMPILE_LOCK file has been removed."
            stop_worldserver
            copy_config
            start_worldserver
            last_modified=0
        fi
    fi
    sleep 1
done